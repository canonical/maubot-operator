# Copyright 2024 Canonical Ltd.
# See LICENSE file for licensing details.

name: maubot
title: maubot
description: |
  A Juju charm deploying and managing maubot on Kubernetes. Maubot is a
  plugin-based Matrix bot system written in Python.
summary: An operator deploying and managing maubot.
links:
  issues: https://github.com/canonical/maubot-operator/issues
  source: https://github.com/canonical/maubot-operator
  contact:
    - https://launchpad.net/~canonical-is-devops

config:
  options:
    public-url:
      description: >-
        Public base URL where the server is visible.
      type: string
      default: "https://maubot.local"

resources:
  maubot-image:
    type: oci-image
    description: OCI image for maubot

containers:
  maubot:
    resource: maubot-image
    mounts:
    - storage: data
      location: /data
storage:
  data:
    type: filesystem

type: charm
base: ubuntu@24.04
build-base: ubuntu@24.04
platforms:
  amd64:

parts:
  charm:
    build-packages:
      - cargo
      - libffi-dev
      - libssl-dev
      - pkg-config
      - rustc

assumes:
  - juju >= 3.4

requires:
  postgresql:
    interface: postgresql_client
    limit: 1
  ingress:
    interface: ingress

actions:
  register-client-account:
    description: Register Matrix client account for a bot. The result is user ID,
      password, access token and device ID that should be used for registering a
      client.

      See Maubot documentation for more details.
      https://docs.mau.fi/maubot/usage/basic.html#creating-clients
    params:
      admin-name:
        type: string
        description: The name of the administrator user that will be used for
          creating the account.
      admin-password:
        type: string
        description: The password of the administrator user that will be used
          for creating the account.
      account-name:
        type: string
        description: The account name.

